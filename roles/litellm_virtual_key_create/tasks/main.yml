---
# LiteLLM Virtual Key Create - Main Tasks

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - guid is defined
      - guid | length > 0
      - litellm_url is defined
      - litellm_url | length > 0
      - litellm_master_key is defined
      - litellm_master_key | length > 0
    fail_msg: "Required variables missing: guid, litellm_url, litellm_master_key"
    quiet: true

- name: Set key alias based on GUID
  ansible.builtin.set_fact:
    _litellm_key_alias: "{{ litellm_key_alias_format }}"

- name: Determine subscription package details
  when: litellm_subscription_package != "custom"
  ansible.builtin.set_fact:
    _litellm_models: "{{ litellm_model_packages[litellm_subscription_package].models }}"
    _litellm_duration: "{{ litellm_model_packages[litellm_subscription_package].duration }}"
    _litellm_package_description: "{{ litellm_model_packages[litellm_subscription_package].description }}"

- name: Use custom model selection
  when: litellm_subscription_package == "custom"
  ansible.builtin.set_fact:
    _litellm_models: "{{ litellm_selected_models }}"
    _litellm_duration: "{{ litellm_key_duration }}"
    _litellm_package_description: "Custom model selection"

- name: Validate models list
  ansible.builtin.assert:
    that:
      - _litellm_models is defined
      - _litellm_models | length > 0
    fail_msg: "No models specified. Check subscription package or custom model selection."
    quiet: true

- name: Set user ID
  ansible.builtin.set_fact:
    _litellm_user_id: "{{ litellm_user_id_format }}"

- name: Build metadata
  ansible.builtin.set_fact:
    _litellm_metadata:
      guid: "{{ guid }}"
      subscription_package: "{{ litellm_subscription_package }}"
      models_count: "{{ _litellm_models | length }}"
      created_by: "{{ litellm_key_metadata.created_by }}"
      environment: "{{ litellm_key_metadata.environment }}"
      catalog_item: "{{ catalog_item | default('unknown') }}"

- name: Display key creation details
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Creating LiteLLM Virtual Key"
      - "========================================="
      - "GUID: {{ guid }}"
      - "Key Alias: {{ _litellm_key_alias }}"
      - "Subscription: {{ litellm_subscription_package }}"
      - "Models: {{ _litellm_models | join(', ') }}"
      - "Duration: {{ _litellm_duration }}"
      - "User ID: {{ _litellm_user_id }}"
      - "========================================="

- name: Check if virtual key already exists (idempotency)
  ansible.builtin.uri:
    url: "{{ litellm_url }}/key/info?key={{ _litellm_key_alias }}"
    method: GET
    headers:
      Authorization: "Bearer {{ litellm_master_key }}"
      Content-Type: "application/json"
    validate_certs: "{{ litellm_verify_ssl }}"
    timeout: "{{ litellm_api_timeout }}"
    status_code: [200, 404]
  register: _litellm_key_check
  failed_when: false

- name: Set key exists flag
  ansible.builtin.set_fact:
    _litellm_key_exists: "{{ _litellm_key_check.status == 200 }}"

- name: Skip key creation if already exists
  when: _litellm_key_exists
  ansible.builtin.debug:
    msg: "Virtual key '{{ _litellm_key_alias }}' already exists. Skipping creation."

- name: Create virtual key via LiteLLM API
  when: not _litellm_key_exists
  block:
    - name: Build API request body
      ansible.builtin.set_fact:
        _litellm_request_body:
          models: "{{ _litellm_models }}"
          duration: "{{ _litellm_duration }}"
          user_id: "{{ _litellm_user_id }}"
          key_alias: "{{ _litellm_key_alias }}"
          metadata: "{{ _litellm_metadata }}"

    - name: Add max_budget if specified
      when: litellm_max_budget is not none
      ansible.builtin.set_fact:
        _litellm_request_body: "{{ _litellm_request_body | combine({'max_budget': litellm_max_budget}) }}"

    - name: Call LiteLLM key generation API
      ansible.builtin.uri:
        url: "{{ litellm_url }}/key/generate"
        method: POST
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ _litellm_request_body }}"
        validate_certs: "{{ litellm_verify_ssl }}"
        timeout: "{{ litellm_api_timeout }}"
        status_code: [200, 201]
      register: _litellm_api_response
      retries: "{{ litellm_retry_count }}"
      delay: "{{ litellm_retry_delay }}"
      until: _litellm_api_response is succeeded

    - name: Extract generated key from response
      ansible.builtin.set_fact:
        litellm_virtual_key: "{{ _litellm_api_response.json.key }}"
        litellm_key_alias: "{{ _litellm_key_alias }}"
        litellm_api_endpoint: "{{ litellm_url }}"
        litellm_available_models: "{{ _litellm_models }}"
        litellm_key_duration: "{{ _litellm_duration }}"

    - name: Display virtual key creation success
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Virtual Key Created Successfully!"
          - "========================================="
          - "Key Alias: {{ litellm_key_alias }}"
          - "Virtual Key: {{ litellm_virtual_key }}"
          - "API Endpoint: {{ litellm_api_endpoint }}"
          - "Models: {{ litellm_available_models | join(', ') }}"
          - "Duration: {{ litellm_key_duration }}"
          - "========================================="

- name: Retrieve existing key if it already existed
  when: _litellm_key_exists
  block:
    - name: Set facts from existing key
      ansible.builtin.set_fact:
        litellm_virtual_key: "{{ _litellm_key_check.json.key }}"
        litellm_key_alias: "{{ _litellm_key_alias }}"
        litellm_api_endpoint: "{{ litellm_url }}"
        litellm_available_models: "{{ _litellm_models }}"
        litellm_key_duration: "{{ _litellm_duration }}"

    - name: Display existing key info
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Using Existing Virtual Key"
          - "========================================="
          - "Key Alias: {{ litellm_key_alias }}"
          - "Virtual Key: {{ litellm_virtual_key }}"
          - "========================================="
