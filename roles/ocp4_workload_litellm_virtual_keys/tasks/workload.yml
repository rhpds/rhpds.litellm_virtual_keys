---
# =============================================================================
# LiteLLM Virtual Keys Workload - Provision Tasks
# =============================================================================
# Creates a virtual key for accessing LiteLLM AI models
# Key naming: virtkey-{GUID}
# Supports subscription packages (ai-beginner, ai-developer, etc.)
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Validate Required Variables
# -----------------------------------------------------------------------------
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - guid is defined
      - guid | length > 0
      - litellm_url is defined
      - litellm_url | length > 0
      - litellm_master_key is defined
      - litellm_master_key | length > 0
    fail_msg: "Required variables missing: guid, litellm_url, litellm_master_key"
    quiet: true

# -----------------------------------------------------------------------------
# Step 2: Set Key Alias
# -----------------------------------------------------------------------------
# Format: virtkey-{GUID}
# This creates a predictable, unique identifier for each lab environment
- name: Set key alias based on GUID
  ansible.builtin.set_fact:
    _litellm_key_alias: "{{ ocp4_workload_litellm_virtual_keys_alias_format }}"

# -----------------------------------------------------------------------------
# Step 3: Set Models and Duration
# -----------------------------------------------------------------------------
# Use the models and duration provided from AgnosticV
# If agnosticd_user_info.runtime is available, use it (CI lifecycle integration)
# Otherwise fall back to configured duration
- name: Set models and duration
  ansible.builtin.set_fact:
    _litellm_models: "{{ ocp4_workload_litellm_virtual_keys_models }}"
    _litellm_duration: "{{ (agnosticd_user_info.runtime | default(ocp4_workload_litellm_virtual_keys_duration | regex_replace('d$', '') | int * 24)) | string + 'h' if agnosticd_user_info.runtime is defined else ocp4_workload_litellm_virtual_keys_duration }}"

# -----------------------------------------------------------------------------
# Step 4: Validate Models List
# -----------------------------------------------------------------------------
- name: Validate models list
  ansible.builtin.assert:
    that:
      - _litellm_models is defined
      - _litellm_models | length > 0
    fail_msg: "No models specified. Check subscription package or custom model selection."
    quiet: true

# -----------------------------------------------------------------------------
# Step 5: Set User ID
# -----------------------------------------------------------------------------
# Uses email if provided, otherwise generates from GUID
- name: Set user ID
  ansible.builtin.set_fact:
    _litellm_user_id: "{{ ocp4_workload_litellm_virtual_keys_user_id_format }}"

# -----------------------------------------------------------------------------
# Step 6: Set API Endpoint
# -----------------------------------------------------------------------------
# Set this early so it's available for all subsequent tasks
# Remove trailing slash from URL if present
- name: Set API endpoint
  ansible.builtin.set_fact:
    litellm_api_endpoint: "{{ litellm_url | regex_replace('/$', '') }}"
    litellm_available_models: "{{ _litellm_models }}"
    litellm_key_duration: "{{ _litellm_duration }}"

# -----------------------------------------------------------------------------
# Step 7: Build Metadata
# -----------------------------------------------------------------------------
# Metadata is used for tracking and auditing in LiteLLM
- name: Build metadata
  ansible.builtin.set_fact:
    _litellm_metadata:
      guid: "{{ guid }}"
      models: "{{ _litellm_models | join(',') }}"
      duration: "{{ _litellm_duration }}"
      models_count: "{{ _litellm_models | length }}"
      created_by: "{{ ocp4_workload_litellm_virtual_keys_metadata.created_by }}"
      environment: "{{ ocp4_workload_litellm_virtual_keys_metadata.environment }}"
      catalog_item: "{{ catalog_item | default('unknown') }}"

# -----------------------------------------------------------------------------
# Step 8: Display Key Creation Details
# -----------------------------------------------------------------------------
- name: Display key creation details
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Creating LiteLLM Virtual Key"
      - "========================================="
      - "GUID: {{ guid }}"
      - "Key Alias: {{ _litellm_key_alias }}"
      - "Models: {{ _litellm_models | join(', ') }}"
      - "Duration: {{ _litellm_duration }}"
      - "User ID: {{ _litellm_user_id }}"
      - "========================================="

# -----------------------------------------------------------------------------
# Step 9: Create Virtual Key via LiteLLM API
# -----------------------------------------------------------------------------
- name: Create virtual key via LiteLLM API
  block:
    # Build the API request body
    - name: Build API request body
      ansible.builtin.set_fact:
        _litellm_request_body:
          models: "{{ _litellm_models }}"
          duration: "{{ _litellm_duration }}"
          user_id: "{{ _litellm_user_id }}"
          key_alias: "{{ _litellm_key_alias }}"
          metadata: "{{ _litellm_metadata }}"

    # Add max_budget if specified (null = unlimited)
    - name: Add max_budget if specified
      when: ocp4_workload_litellm_virtual_keys_max_budget is not none
      ansible.builtin.set_fact:
        _litellm_request_body: "{{ _litellm_request_body | combine({'max_budget': ocp4_workload_litellm_virtual_keys_max_budget}) }}"

    # Debug: Show the API request being sent
    - name: Debug API request
      ansible.builtin.debug:
        msg:
          - "API URL: {{ litellm_api_endpoint }}/key/generate"
          - "Request Body: {{ _litellm_request_body | to_nice_json }}"
          - "Models: {{ _litellm_request_body.models }}"
          - "Duration: {{ _litellm_request_body.duration }}"
          - "Key Alias: {{ _litellm_request_body.key_alias }}"

    # Call the LiteLLM API to generate the key
    # Status codes:
    #   200/201: Key created successfully
    #   400: Key already exists (idempotent operation)
    - name: Call LiteLLM key generation API
      ansible.builtin.uri:
        url: "{{ litellm_api_endpoint }}/key/generate"
        method: POST
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ _litellm_request_body }}"
        validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
        timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
        status_code: [200, 201, 400]
      register: _litellm_api_response
      failed_when: false  # Don't fail, we'll handle status in next task

    # Determine if key was created or already existed
    - name: Set key created flag
      ansible.builtin.set_fact:
        _litellm_key_created: "{{ _litellm_api_response.status in [200, 201] }}"
        _litellm_key_already_exists: "{{ _litellm_api_response.status == 400 }}"

    # -----------------------------------------------------------------------------
    # Step 10: Extract Key from Response
    # -----------------------------------------------------------------------------
    # Set the virtual key based on whether it's new or existing
    # NOTE: If key already exists, LiteLLM API does not return the actual key value
    # In that case, we cannot retrieve it and must create a new one with different alias
    - name: Set virtual key facts
      ansible.builtin.set_fact:
        litellm_virtual_key: "{{ _litellm_api_response.get('key', _litellm_api_response.get('json', {}).get('key', 'KEY_NOT_FOUND')) if _litellm_key_created else 'KEY_ALREADY_EXISTS_CANNOT_RETRIEVE' }}"
        litellm_key_alias: "{{ _litellm_key_alias }}"
        litellm_key_id: "{{ _litellm_api_response.get('key_id', _litellm_api_response.get('json', {}).get('key_id', _litellm_api_response.get('json', {}).get('token', ''))) }}"

    # Validate that we got a key
    - name: Validate key was retrieved
      when: not _litellm_key_created and not _litellm_key_already_exists
      ansible.builtin.fail:
        msg: |
          API call succeeded but key status is unclear.
          API Status: {{ _litellm_api_response.status }}
          Response: {{ _litellm_api_response | to_nice_json }}

          This is unexpected. Please check:
          1. LiteLLM API logs
          2. The response structure from /key/generate endpoint

    # Fail if key already exists (we cannot retrieve existing keys from LiteLLM)
    - name: Fail if key already exists
      when: _litellm_key_already_exists
      ansible.builtin.fail:
        msg: |
          Key with alias '{{ _litellm_key_alias }}' already exists but cannot be retrieved.
          LiteLLM API does not return existing key values for security reasons.

          Options:
          1. Delete the existing key first using ACTION=destroy
          2. Use a different GUID to create a new key

          To delete: Run with ACTION=destroy and the same guid

    # Validate we have an actual key value
    - name: Ensure key value exists
      when: _litellm_key_created
      ansible.builtin.assert:
        that:
          - litellm_virtual_key is defined
          - litellm_virtual_key | length > 0
          - litellm_virtual_key is match('^sk-')
        fail_msg: |
          Key was created but no valid key value was returned.
          Got: {{ litellm_virtual_key | default('undefined') }}
          Expected: sk-xxxxx format
          Response: {{ _litellm_api_response | to_nice_json }}

    # -----------------------------------------------------------------------------
    # Step 12: Display Success Messages
    # -----------------------------------------------------------------------------
    - name: Display virtual key creation success
      when: _litellm_key_created
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Virtual Key Created Successfully!"
          - "========================================="
          - "Key Alias: {{ litellm_key_alias }}"
          - "Virtual Key: {{ litellm_virtual_key }}"
          - "API Endpoint: {{ litellm_api_endpoint }}"
          - "Models: {{ litellm_available_models | join(', ') }}"
          - "Duration: {{ litellm_key_duration }}"
          - "========================================="

    - name: Display existing key info
      when: _litellm_key_already_exists
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Key Already Exists (Idempotent)"
          - "========================================="
          - "Key Alias: {{ litellm_key_alias }}"
          - "Note: Using existing key {{ _litellm_key_alias }}"
          - "========================================="

# -----------------------------------------------------------------------------
# Step 13: Send User Info Messages (AgnosticD Integration)
# -----------------------------------------------------------------------------
# These messages are shown to users in emails and the RHDP UI
- name: Print user info messages
  when: ocp4_workload_litellm_virtual_keys_enable_user_info_messages | bool
  rhpds.litellm_virtual_keys.agnosticd_user_info:
    msg: "{{ item }}"
  loop:
    - "LiteLLM API Endpoint: {{ litellm_api_endpoint }}/v1"
    - "LiteLLM Virtual Key: {{ litellm_virtual_key }}"
    - "Available Models: {{ litellm_available_models | join(', ') }}"
    - "Key Duration: {{ litellm_key_duration }}"

# Send any custom messages provided by the caller
- name: Print custom user info messages
  when:
    - ocp4_workload_litellm_virtual_keys_enable_user_info_messages | bool
    - ocp4_workload_litellm_virtual_keys_user_info_messages | length > 0
  rhpds.litellm_virtual_keys.agnosticd_user_info:
    msg: "{{ item }}"
  loop: "{{ ocp4_workload_litellm_virtual_keys_user_info_messages }}"

# -----------------------------------------------------------------------------
# Step 14: Save User Info Data (AgnosticD Integration)
# -----------------------------------------------------------------------------
# This data is stored for programmatic access via APIs
# Includes key_id for lifecycle extension support
# NOTE: master_key is NOT exposed to users for security reasons
- name: Save user info data
  when: ocp4_workload_litellm_virtual_keys_enable_user_info_data | bool
  rhpds.litellm_virtual_keys.agnosticd_user_info:
    data:
      litellm_api_endpoint: "{{ litellm_api_endpoint }}"
      litellm_api_base_url: "{{ litellm_api_endpoint }}/v1"
      litellm_virtual_key: "{{ litellm_virtual_key }}"
      litellm_key_alias: "{{ litellm_key_alias }}"
      litellm_key_id: "{{ litellm_key_id }}"
      litellm_available_models: "{{ litellm_available_models }}"
      litellm_available_models_list: "{{ litellm_available_models | join(', ') }}"
      litellm_key_duration: "{{ litellm_key_duration }}"
