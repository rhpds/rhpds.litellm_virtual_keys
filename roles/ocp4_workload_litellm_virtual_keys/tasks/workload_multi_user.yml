---
# =============================================================================
# LiteLLM Virtual Keys Workload - Multi-User Provision Tasks
# =============================================================================
# Creates one virtual key per user
# Key naming: virtkey-{GUID}-user1, virtkey-{GUID}-user2, etc.
# All users get same models and duration
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Validate Multi-User Configuration
# -----------------------------------------------------------------------------
- name: Validate multi-user configuration
  ansible.builtin.assert:
    that:
      - ocp4_workload_litellm_virtual_keys_user_count is defined
      - ocp4_workload_litellm_virtual_keys_user_count | int > 0
    fail_msg: |
      Multi-user mode enabled but num_users not specified or invalid.
      Please set num_users to the number of users to provision (e.g., num_users: 10)
    quiet: false

- name: Display multi-user configuration
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Multi-User Mode Enabled"
      - "========================================="
      - "Number of users: {{ ocp4_workload_litellm_virtual_keys_user_count }}"
      - "User base: {{ ocp4_workload_litellm_virtual_keys_user_base }}"
      - "Key pattern: virtkey-{{ guid }}-{{ ocp4_workload_litellm_virtual_keys_user_base }}N"
      - "Email domain: {{ ocp4_workload_litellm_virtual_keys_user_email_domain }}"
      - "Models: {{ ocp4_workload_litellm_virtual_keys_models | join(', ') }}"
      - "Duration: {{ ocp4_workload_litellm_virtual_keys_duration }}"
      - "========================================="

# -----------------------------------------------------------------------------
# Step 2: Set Common Variables
# -----------------------------------------------------------------------------
- name: Set common multi-user variables
  ansible.builtin.set_fact:
    _litellm_models: "{{ ocp4_workload_litellm_virtual_keys_models }}"
    _litellm_duration: "{{ (agnosticd_user_info.runtime | default(ocp4_workload_litellm_virtual_keys_duration | regex_replace('d$', '') | int * 24)) | string + 'h' if agnosticd_user_info.runtime is defined else ocp4_workload_litellm_virtual_keys_duration }}"
    litellm_api_endpoint: "{{ litellm_url | regex_replace('/$', '') }}"
    litellm_available_models: "{{ ocp4_workload_litellm_virtual_keys_models }}"
    litellm_key_duration: "{{ ocp4_workload_litellm_virtual_keys_duration }}"

# Initialize arrays for storing results
- name: Initialize result arrays
  ansible.builtin.set_fact:
    _litellm_virtual_keys: []
    _litellm_key_aliases: []
    _litellm_key_ids: []
    _litellm_user_ids: []

# -----------------------------------------------------------------------------
# Step 3: Create Virtual Keys for Each User
# -----------------------------------------------------------------------------
- name: Create virtual key for each user
  include_tasks:
    file: ./workload_multi_user_create_key.yml
  loop: "{{ range(1, ocp4_workload_litellm_virtual_keys_user_count | int + 1) | list }}"
  loop_control:
    loop_var: user_number
    label: "{{ ocp4_workload_litellm_virtual_keys_user_base }}{{ user_number }}"

# -----------------------------------------------------------------------------
# Step 4: Send User Info Messages
# -----------------------------------------------------------------------------
- name: Print multi-user info summary
  when: ocp4_workload_litellm_virtual_keys_enable_user_info_messages | bool
  rhpds.litellm_virtual_keys.agnosticd_user_info:
    msg: "{{ item }}"
  loop:
    - "LiteLLM API Endpoint: {{ litellm_api_endpoint }}/v1"
    - "Created {{ ocp4_workload_litellm_virtual_keys_user_count }} virtual keys"
    - "Available Models: {{ litellm_available_models | join(', ') }}"
    - "Key Duration: {{ litellm_key_duration }}"

# -----------------------------------------------------------------------------
# Step 5: Save User Info Data
# -----------------------------------------------------------------------------
# Strategy: Provide BOTH per-user variables AND array format
#
# Per-user variables (auto-render in Showroom based on logged-in user):
#   - litellm_user1_virtual_key
#   - litellm_user2_virtual_key
#
# Array format (for programmatic access):
#   - litellm_virtual_keys: [...]
#   - litellm_key_aliases: [...]

- name: Build per-user data dictionary
  ansible.builtin.set_fact:
    _litellm_user_data: "{{ _litellm_user_data | default({}) | combine({item.key: item.value}) }}"
  loop: "{{ _litellm_per_user_data_list }}"
  loop_control:
    label: "{{ item.key }}"

- name: Save multi-user info data
  when: ocp4_workload_litellm_virtual_keys_enable_user_info_data | bool
  rhpds.litellm_virtual_keys.agnosticd_user_info:
    data: "{{ _litellm_user_data | combine({
      'litellm_api_endpoint': litellm_api_endpoint,
      'litellm_api_base_url': litellm_api_endpoint + '/v1',
      'litellm_available_models': litellm_available_models,
      'litellm_available_models_list': litellm_available_models | join(', '),
      'litellm_key_duration': litellm_key_duration,
      'litellm_user_count': ocp4_workload_litellm_virtual_keys_user_count | int,
      'litellm_virtual_keys': _litellm_virtual_keys,
      'litellm_key_aliases': _litellm_key_aliases,
      'litellm_key_ids': _litellm_key_ids,
      'litellm_user_ids': _litellm_user_ids,
      'litellm_virtual_key': _litellm_virtual_keys[0] if _litellm_virtual_keys | length > 0 else '',
      'litellm_key_alias': _litellm_key_aliases[0] if _litellm_key_aliases | length > 0 else '',
      'litellm_key_id': _litellm_key_ids[0] if _litellm_key_ids | length > 0 else ''
    }) }}"
