---
# =============================================================================
# LiteLLM Virtual Keys Workload - Removal Tasks
# =============================================================================
# Deletes a virtual key from LiteLLM
# Supports deletion by alias (virtkey-{GUID}) or by key_id
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Validate Required Variables
# -----------------------------------------------------------------------------
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - litellm_url is defined
      - litellm_url | length > 0
      - litellm_master_key is defined
      - litellm_master_key | length > 0
    fail_msg: "Required variables missing: litellm_url, litellm_master_key"
    quiet: true

# Validate GUID for alias-based deletion
- name: Validate deletion method
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_alias"
  ansible.builtin.assert:
    that:
      - guid is defined
      - guid | length > 0
    fail_msg: "GUID required for by_alias deletion method"
    quiet: true

# Validate key_id for ID-based deletion
- name: Validate key_id for by_key_id method
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_key_id"
  ansible.builtin.assert:
    that:
      - ocp4_workload_litellm_virtual_keys_key_id is defined
      - ocp4_workload_litellm_virtual_keys_key_id | length > 0
    fail_msg: "ocp4_workload_litellm_virtual_keys_key_id required for by_key_id deletion method"
    quiet: true

# -----------------------------------------------------------------------------
# Step 2: Determine Key to Delete
# -----------------------------------------------------------------------------
# Set the key alias (virtkey-{GUID})
- name: Set key alias for deletion
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_alias"
  ansible.builtin.set_fact:
    _litellm_key_to_delete: "{{ ocp4_workload_litellm_virtual_keys_alias_format }}"
    _litellm_deletion_label: "alias '{{ ocp4_workload_litellm_virtual_keys_alias_format }}'"

# Or use the key ID directly
- name: Set key ID for deletion
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_key_id"
  ansible.builtin.set_fact:
    _litellm_key_to_delete: "{{ ocp4_workload_litellm_virtual_keys_key_id }}"
    _litellm_deletion_label: "key ID '{{ ocp4_workload_litellm_virtual_keys_key_id }}'"

# -----------------------------------------------------------------------------
# Step 3: Display Deletion Details
# -----------------------------------------------------------------------------
- name: Display deletion details
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Deleting LiteLLM Virtual Key"
      - "========================================="
      - "Method: {{ ocp4_workload_litellm_virtual_keys_delete_method }}"
      - "Target: {{ _litellm_deletion_label }}"
      - "========================================="

# -----------------------------------------------------------------------------
# Step 4: Check if Key Exists
# -----------------------------------------------------------------------------
- name: Check if virtual key exists before deletion
  ansible.builtin.uri:
    url: "{{ litellm_url }}/key/info?key={{ _litellm_key_to_delete }}"
    method: GET
    headers:
      Authorization: "Bearer {{ litellm_master_key }}"
      Content-Type: "application/json"
    validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
    timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
    status_code: [200, 404]
  register: _litellm_key_check
  failed_when: false

- name: Set key exists flag
  ansible.builtin.set_fact:
    _litellm_key_exists: "{{ _litellm_key_check.status == 200 }}"

# -----------------------------------------------------------------------------
# Step 5: Handle Missing Key (Idempotent)
# -----------------------------------------------------------------------------
- name: Skip deletion if key doesn't exist
  when: not _litellm_key_exists
  ansible.builtin.debug:
    msg: "Virtual key {{ _litellm_deletion_label }} does not exist. Nothing to delete (idempotent)."

# -----------------------------------------------------------------------------
# Step 6: Delete the Key
# -----------------------------------------------------------------------------
- name: Delete virtual key via LiteLLM API
  when: _litellm_key_exists
  block:
    - name: Call LiteLLM key deletion API
      ansible.builtin.uri:
        url: "{{ litellm_url }}/key/delete"
        method: POST
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        body_format: json
        body:
          keys: ["{{ _litellm_key_to_delete }}"]
        validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
        timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
        status_code: [200, 201, 204]
      register: _litellm_delete_response
      retries: "{{ ocp4_workload_litellm_virtual_keys_retry_count }}"
      delay: "{{ ocp4_workload_litellm_virtual_keys_retry_delay }}"
      until: _litellm_delete_response is succeeded

    - name: Display deletion success
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Virtual Key Deleted Successfully!"
          - "========================================="
          - "Deleted: {{ _litellm_deletion_label }}"
          - "========================================="

# -----------------------------------------------------------------------------
# Step 7: Set Deletion Result Facts
# -----------------------------------------------------------------------------
- name: Set deletion result fact
  ansible.builtin.set_fact:
    litellm_key_deleted: "{{ _litellm_key_exists }}"
    litellm_key_was_missing: "{{ not _litellm_key_exists }}"
