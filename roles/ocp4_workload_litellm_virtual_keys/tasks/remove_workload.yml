---
# =============================================================================
# LiteLLM Virtual Keys Workload - Removal Tasks
# =============================================================================
# Deletes a virtual key from LiteLLM
# Supports deletion by alias (virtkey-{GUID}) or by key_id
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Validate Required Variables
# -----------------------------------------------------------------------------
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - litellm_url is defined
      - litellm_url | length > 0
      - litellm_master_key is defined
      - litellm_master_key | length > 0
    fail_msg: "Required variables missing: litellm_url, litellm_master_key"
    quiet: true

# Validate GUID for alias-based deletion
- name: Validate deletion method
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_alias"
  ansible.builtin.assert:
    that:
      - guid is defined
      - guid | length > 0
    fail_msg: "GUID required for by_alias deletion method"
    quiet: true

# Validate key_id for ID-based deletion
- name: Validate key_id for by_key_id method
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_key_id"
  ansible.builtin.assert:
    that:
      - ocp4_workload_litellm_virtual_keys_key_id is defined
      - ocp4_workload_litellm_virtual_keys_key_id | length > 0
    fail_msg: "ocp4_workload_litellm_virtual_keys_key_id required for by_key_id deletion method"
    quiet: true

# -----------------------------------------------------------------------------
# Step 2: Determine Key to Delete
# -----------------------------------------------------------------------------
# Set the key alias (virtkey-{GUID})
- name: Set key alias for deletion
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_alias"
  ansible.builtin.set_fact:
    _litellm_key_to_delete: "{{ ocp4_workload_litellm_virtual_keys_alias_format }}"
    _litellm_deletion_label: "alias '{{ ocp4_workload_litellm_virtual_keys_alias_format }}'"

# Or use the key ID directly
- name: Set key ID for deletion
  when: ocp4_workload_litellm_virtual_keys_delete_method == "by_key_id"
  ansible.builtin.set_fact:
    _litellm_key_to_delete: "{{ ocp4_workload_litellm_virtual_keys_key_id }}"
    _litellm_deletion_label: "key ID '{{ ocp4_workload_litellm_virtual_keys_key_id }}'"

# -----------------------------------------------------------------------------
# Step 3: Display Deletion Details
# -----------------------------------------------------------------------------
- name: Display deletion details
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Deleting LiteLLM Virtual Key"
      - "========================================="
      - "Method: {{ ocp4_workload_litellm_virtual_keys_delete_method }}"
      - "Target: {{ _litellm_deletion_label }}"
      - "========================================="

# -----------------------------------------------------------------------------
# Step 4: List All Keys and Find the One to Delete
# -----------------------------------------------------------------------------
# Strategy:
# 1. Get list of all token hashes from /key/list
# 2. For each token, get detailed info from /key/info?key={token}
# 3. Find the one matching our alias
- name: List all virtual key token hashes
  ansible.builtin.uri:
    url: "{{ litellm_url }}/key/list"
    method: GET
    headers:
      Authorization: "Bearer {{ litellm_master_key }}"
      Content-Type: "application/json"
    validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
    timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
    status_code: [200]
  register: _litellm_key_list
  failed_when: false

- name: Initialize variables
  ansible.builtin.set_fact:
    _litellm_found_key_hash: ""
    _litellm_key_exists: false

- name: Search for key by alias
  when:
    - _litellm_key_list.status == 200
    - _litellm_key_list.json.keys is defined
    - _litellm_key_list.json.keys | length > 0
  block:
    - name: Get detailed info for each key and find matching alias
      ansible.builtin.uri:
        url: "{{ litellm_url }}/key/info?key={{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
        timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
        status_code: [200, 404]
      register: _litellm_key_details
      loop: "{{ _litellm_key_list.json.keys }}"
      failed_when: false

    - name: Find key with matching alias
      ansible.builtin.set_fact:
        _litellm_found_key_hash: "{{ item.json.key }}"
        _litellm_key_exists: true
      when:
        - item.status == 200
        - item.json.info is defined
        - item.json.info.key_alias is defined
        - item.json.info.key_alias == _litellm_key_to_delete
      loop: "{{ _litellm_key_details.results }}"
      loop_control:
        label: "{{ item.json.info.key_alias if (item.status == 200 and item.json.info is defined and item.json.info.key_alias is defined) else 'N/A' }}"

- name: Debug key search results
  ansible.builtin.debug:
    msg:
      - "Key search results:"
      - "  Looking for alias: {{ _litellm_key_to_delete }}"
      - "  Key found: {{ _litellm_key_exists }}"
      - "  Token hash: {{ _litellm_found_key_hash if _litellm_found_key_hash else 'N/A' }}"

# -----------------------------------------------------------------------------
# Step 5: Handle Missing Key (Idempotent)
# -----------------------------------------------------------------------------
- name: Skip deletion if key doesn't exist
  when: not _litellm_key_exists
  ansible.builtin.debug:
    msg: "Virtual key {{ _litellm_deletion_label }} does not exist. Nothing to delete (idempotent)."

# -----------------------------------------------------------------------------
# Step 6: Delete the Key Using Token Hash
# -----------------------------------------------------------------------------
- name: Delete virtual key via LiteLLM API
  when: _litellm_key_exists
  block:
    - name: Display key info before deletion
      ansible.builtin.debug:
        msg:
          - "Found key to delete:"
          - "  Alias: {{ _litellm_key_to_delete }}"
          - "  Token: {{ _litellm_found_key_hash }}"

    - name: Call LiteLLM key deletion API with token hash
      ansible.builtin.uri:
        url: "{{ litellm_url }}/key/delete"
        method: POST
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        body_format: json
        body:
          keys: ["{{ _litellm_found_key_hash }}"]
        validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
        timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
        status_code: [200, 201, 204]
      register: _litellm_delete_response
      retries: "{{ ocp4_workload_litellm_virtual_keys_retry_count }}"
      delay: "{{ ocp4_workload_litellm_virtual_keys_retry_delay }}"
      until: _litellm_delete_response is succeeded

    - name: Display delete API response
      ansible.builtin.debug:
        var: _litellm_delete_response.json

    - name: Wait for deletion to propagate
      ansible.builtin.pause:
        seconds: 2

    - name: Verify key was deleted
      ansible.builtin.uri:
        url: "{{ litellm_url }}/key/info"
        method: GET
        headers:
          Authorization: "Bearer {{ litellm_master_key }}"
          Content-Type: "application/json"
        validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
        timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
        status_code: [200]
      register: _litellm_verify_delete
      failed_when: false

    - name: Check if key still exists after deletion
      ansible.builtin.set_fact:
        _litellm_key_still_exists: "{{ _litellm_verify_delete.json.keys | selectattr('key_alias', 'equalto', _litellm_key_to_delete) | list | length > 0 }}"
      when:
        - _litellm_verify_delete.status == 200
        - _litellm_verify_delete.json.keys is defined

    - name: Warn if key still exists
      ansible.builtin.debug:
        msg:
          - "WARNING: Key {{ _litellm_key_to_delete }} still exists after API deletion!"
          - "This is a known issue with LiteLLM's delete API."
          - "Attempting database deletion if force_db_delete is enabled..."
      when: _litellm_key_still_exists | default(false)

    # ---------------------------------------------------------------------
    # Force database deletion (workaround for LiteLLM bug)
    # ---------------------------------------------------------------------
    - name: Force delete from database (workaround for LiteLLM API bug)
      when:
        - _litellm_key_still_exists | default(false)
        - ocp4_workload_litellm_virtual_keys_force_db_delete | bool
      block:
        - name: Delete key directly from PostgreSQL database
          kubernetes.core.k8s_exec:
            namespace: "{{ ocp4_workload_litellm_virtual_keys_namespace }}"
            pod: "{{ ocp4_workload_litellm_virtual_keys_postgres_pod }}"
            command: >-
              psql -U postgres -d {{ ocp4_workload_litellm_virtual_keys_postgres_db }} -c
              "DELETE FROM \"LiteLLM_VerificationToken\" WHERE token = '{{ _litellm_found_key_hash }}';"
          register: _litellm_db_delete
          failed_when: false

        - name: Display database deletion result
          ansible.builtin.debug:
            var: _litellm_db_delete

        - name: Wait for database deletion to propagate
          ansible.builtin.pause:
            seconds: 2

        - name: Verify database deletion
          ansible.builtin.uri:
            url: "{{ litellm_url }}/key/info"
            method: GET
            headers:
              Authorization: "Bearer {{ litellm_master_key }}"
              Content-Type: "application/json"
            validate_certs: "{{ ocp4_workload_litellm_virtual_keys_verify_ssl }}"
            timeout: "{{ ocp4_workload_litellm_virtual_keys_api_timeout }}"
            status_code: [200]
          register: _litellm_final_verify
          failed_when: false

        - name: Check final deletion status
          ansible.builtin.set_fact:
            _litellm_key_finally_deleted: "{{ _litellm_final_verify.json.keys | selectattr('key_alias', 'equalto', _litellm_key_to_delete) | list | length == 0 }}"
          when:
            - _litellm_final_verify.status == 200
            - _litellm_final_verify.json.keys is defined

        - name: Display final deletion status
          ansible.builtin.debug:
            msg:
              - "========================================="
              - "Database Deletion Complete"
              - "========================================="
              - "Key {{ _litellm_key_to_delete }}: {{ 'DELETED' if _litellm_key_finally_deleted else 'STILL EXISTS' }}"
              - "========================================="

    - name: Display deletion success
      when: not (_litellm_key_still_exists | default(false))
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Virtual Key Deleted Successfully!"
          - "========================================="
          - "Deleted: {{ _litellm_deletion_label }}"
          - "Verified: Key no longer exists"
          - "========================================="

# -----------------------------------------------------------------------------
# Step 7: Set Deletion Result Facts
# -----------------------------------------------------------------------------
- name: Set deletion result fact
  ansible.builtin.set_fact:
    litellm_key_deleted: "{{ _litellm_key_exists }}"
    litellm_key_was_missing: "{{ not _litellm_key_exists }}"
