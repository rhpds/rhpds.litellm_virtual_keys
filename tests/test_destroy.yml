---
# =============================================================================
# Test Playbook: LiteLLM Virtual Key Destroy (DELETE)
# =============================================================================
# Purpose: Test deleting virtual keys using the remove_workload.yml pattern
#
# Usage:
#   ansible-playbook test_destroy.yml \
#     -e litellm_url="https://litellm-rhpds.apps.cluster.com" \
#     -e litellm_master_key="sk-xxxxx"
#
# Optional parameters:
#   -e guid="custom-guid"    # Default: test123
#
# Note: This will delete the key created by test_provision.yml
# =============================================================================

- name: Test LiteLLM Virtual Key Destroy
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Test GUID - this will delete key alias "virtkey-test123"
    # Must match the GUID used when creating the key
    guid: "test123"

    # Set ACTION to destroy (delete the key)
    ACTION: "destroy"

  tasks:
    # =========================================================================
    # Task 1: Destroy virtual key
    # =========================================================================
    # Calls the workload role with ACTION=destroy
    # This executes tasks/remove_workload.yml
    # If key doesn't exist, it will gracefully skip (idempotent)
    # =========================================================================
    - name: Destroy virtual key using the collection role
      ansible.builtin.include_role:
        name: rhpds.litellm_virtual_keys.ocp4_workload_litellm_virtual_keys

    # =========================================================================
    # Task 2: Display deletion result
    # =========================================================================
    # Shows whether the key was deleted or was already missing
    # =========================================================================
    - name: Display deletion result
      ansible.builtin.debug:
        msg:
          - "Key deleted: {{ litellm_key_deleted }}"
          - "Key was missing: {{ litellm_key_was_missing }}"
