---
# =============================================================================
# Test Playbook: LiteLLM Virtual Key Provision (CREATE)
# =============================================================================
# Purpose: Test creating virtual keys using the workload.yml pattern
#
# Usage:
#   ansible-playbook test_provision.yml \
#     -e litellm_url="https://litellm-rhpds.apps.cluster.com" \
#     -e litellm_master_key="sk-xxxxx"
#
# Optional parameters:
#   -e guid="custom-guid"                              # Default: test123
#   -e subscription_package="ai-researcher"            # Default: ai-developer
# =============================================================================

- name: Test LiteLLM Virtual Key Provision
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Test GUID - this will create key alias "virtkey-test123"
    guid: "test123"

    # Set ACTION to provision (create the key)
    ACTION: "provision"

    # Subscription package options:
    #   - ai-beginner: Granite only, 7 days
    #   - ai-developer: Granite + Mistral, 30 days (default)
    #   - ai-researcher: Granite + Mistral + Llama, 90 days
    #   - lab-dev: Granite + Mistral, 14 days
    #   - lab-prod: Granite + Mistral, 90 days
    ocp4_workload_litellm_virtual_keys_subscription_package: "{{ subscription_package | default('ai-developer') }}"

    # Disable user_info for standalone testing (no agnosticd.core collection)
    ocp4_workload_litellm_virtual_keys_enable_user_info_messages: false
    ocp4_workload_litellm_virtual_keys_enable_user_info_data: false

  tasks:
    # =========================================================================
    # Task 1: Provision virtual key
    # =========================================================================
    # Calls the workload role with ACTION=provision
    # This executes tasks/workload.yml
    # =========================================================================
    - name: Provision virtual key using the collection role
      ansible.builtin.include_role:
        name: rhpds.litellm_virtual_keys.ocp4_workload_litellm_virtual_keys

    # =========================================================================
    # Task 2: Display the created key information
    # =========================================================================
    - name: Display created key information
      ansible.builtin.debug:
        msg:
          - "Key Alias: {{ litellm_key_alias }}"
          - "Virtual Key: {{ litellm_virtual_key }}"
          - "API Endpoint: {{ litellm_api_endpoint }}/v1"
          - "Models: {{ litellm_available_models | join(', ') }}"
          - "Duration: {{ litellm_key_duration }}"

    # =========================================================================
    # Task 3: Test idempotency
    # =========================================================================
    # Run the role again with the same GUID
    # Should detect existing key and skip creation
    # =========================================================================
    - name: Test idempotency - run provision again with same GUID
      ansible.builtin.include_role:
        name: rhpds.litellm_virtual_keys.ocp4_workload_litellm_virtual_keys

    - name: Idempotency test passed
      ansible.builtin.debug:
        msg: "SUCCESS: Key already existed, creation was skipped (idempotent)"
